---
title: "Austin, TX Mobility Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

<style>                     
.navbar {
  background-color:#bf5700;
}
</style>   


```{r global, include=FALSE}
## Inspiration | https://beta.rstudioconnect.com/jjallaire/htmlwidgets-showcase-storyboard/htmlwidgets-showcase-storyboard.html
## Github Pages: https://www.r-bloggers.com/2020/09/deploying-flexdashboard-on-github-pages/ 

# library(here)
library(config)
library(RSocrata)
library(flexdashboard)
library(shiny)
library(tibble)
library(dplyr)
library(magrittr)
library(lubridate)
library(ggplot2)

config <- config::get(file = "C:/Users/Anna V/Documents/Github/austin_micromobility/00_config/config.yml", use_parent = TRUE)

data_src <- "Data Source: City of Austin Open Data Portal \n https://data.austintexas.gov/"
loc <- "Location: Austin, TX"

min_date <- "2018-04-13" ## start of dataset
max_date <-  "2022-03-01" ## data no longer maintained at this URL as of March 1, 2022

col_orange <- '#bf5700'
```


Inputs {.sidebar}
=====================================  

```{r inputs}
shiny::renderText(data_src)


shiny::dateInput('start_date', 'Start Date: ', 
                 value = as.Date(max_date)-lubridate::weeks(x = 4),
                 min =  min_date, max = max_date,
                 format = "yyyy-mm-dd")

shiny::selectInput('duration', 'Duration: ', 
            choices = c('1 week', '1 month', '1 quarter'), 
            selected = '1 month', multiple = FALSE)

create_end_date <- function(start_date, duration_str){
  if(duration_str == '1 week'){
    end_date <- start_date + lubridate::weeks(x = 1)
  }
  else if(duration_str == '1 month'){
    end_date <- start_date + lubridate::weeks(x = 4)
  }
  else if(duration_str == '1 quarter'){
    end_date <- start_date + lubridate::weeks(x = 12)
  }
  return(as.character(end_date))
}

end_date <- shiny::reactive(create_end_date(input$start_date, input$duration))
shiny::renderPrint(end_date)
```

```{r url}
###https://mastering-shiny.org/basic-reactivity.html
url <- shiny::reactive(as.character(paste0("https://data.austintexas.gov/resource/7d8e-dm7r.csv?",
                              "$where=start_time between ",
                              paste0("'", as.character(input$start_date()), "T00:00:00", "'"),
                              " and ",
                              paste0("'", end_date(), "T23:59:59", "'"),
                              "&vehicle_type=scooter"))
)
```


```{r get_data}
raw <- reactive(RSocrata::read.socrata(url,
                              app_token = config$app_token,
                              email     = config$email,
                              password  = config$password,
                              stringsAsFactors = FALSE
                            )
)

raw <- tibble::as_tibble(raw)
```

Trip Aggregates
=====================================  

Row
-------------------------------------
    
### Hour
    
```{r by_hour}
by_hour <- raw %>%
  group_by(hour) %>%
  summarize(count = n())

shiny::renderPlot(
  ggplot(by_hour,
         aes(x = hour, y = count)) +
    geom_col() +
    geom_text(aes(label = format(count, big.mark = ",")), vjust = -0.3, size = 2) +
    # facet_wrap(vars(year), nrow = 3, scales = "free_y") +
    labs(title = "Number of Scooter Trips by Hour",
         subtitle = loc,
         caption = data_src) +
    ylab("Number of Scooter Trips") +
    xlab("Hour of day [0-23]") +
    scale_x_continuous(breaks = seq(0, 23, 1)) +
    theme_minimal()
  # + scale_fill_manual(values = col3, guide = FALSE)
)
```
 
### Day of Week
    
```{r by_dow}
# by_dow <- raw %>%
#   group_by(day_of_week) %>%
#   summarize(count = n())
# 
# shiny::renderPlot(
#   ggplot(by_dow,
#          aes(x = day_of_week, y = count)) +
#     geom_col() +
#     geom_text(aes(label = format(count, big.mark = ",")), vjust = -0.3, size = 2) +
#     # facet_wrap(vars(year), nrow = 3, scales = "free_y") +
#     labs(title = "Number of Scooter Trips by Day of Week",
#          subtitle = loc,
#          caption = data_src) +
#     ylab("Number of Scooter Trips") +
#     xlab("Day of Week [0-6]") +
#     scale_x_continuous(breaks = seq(0, 6, 1)) +
#     theme_minimal()
#   # + scale_fill_manual(values = col3, guide = FALSE)
# )
``` 

Row
-------------------------------------
    
### Chart 3
    
```{r}
print('Chart 3')
# renderPlot()
```
 
### Chart 4
    
```{r}
print('Chart 4')
# renderPlot()
``` 



Day of Month Heatmap
=====================================  
```{r}
# https://cran.r-project.org/web/packages/sugrrants/vignettes/frame-calendar.html
```


Census Tract Heatmap
=====================================  
